<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EduGenie</title>
        <link rel = "stylesheet" href = "chatPage.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <link rel="icon" href="imgs/icon.png">
        
        </head>
    <body>
        <div class="chat-container">
            <div class="chat-header">eduGenie</div>

            <div id="controls" style="padding: 10px 20px 0; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="saveConversationAsPdf()" style="font-size: 14px; padding: 5px 10px;">Save as PDF</button>
                <button onclick="clearConversation()" style="font-size: 14px; padding: 5px 10px;">Clear Conversation</button>
            </div>
            
            <div class="chat-box" id="conversationArea">
                <div class="message bot">
                    <div class="bubble">Hi there! Let's get started, ask me a question</div>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="prompt" placeholder="Type a message..." />
                <button onclick="askGemini()">Send</button>
            </div>
        </div>

    <script>
        // Array to hold the conversation history (Q&A objects)
        let conversationHistory = [];

        // 1. Core Logic: Ask Gemini
        async function askGemini() {
            const promptInput = document.getElementById("prompt");
            const prompt = promptInput.value.trim();
            
            if (!prompt) return;

            // Display user question immediately
            appendMessage('user', prompt);
            promptInput.value = ''; // Clear input field

            // Add a temporary 'Loading...' message
            const loadingMessageId = `loading-${Date.now()}`;
            appendMessage('bot', '...', loadingMessageId); // Use 'bot' role
            
            try {
                const res = await fetch("http://localhost:5001/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt })
                });

                const data = await res.json();
                
                // Remove the temporary loading message
                const loadingElement = document.getElementById(loadingMessageId);
                if (loadingElement) loadingElement.remove();

                if (data.answer) {
                    // Store in history
                    conversationHistory.push({ role: 'user', content: prompt });
                    conversationHistory.push({ role: 'ai', content: data.answer });

                    // Display the final AI answer
                    appendMessage('bot', data.answer); // Use 'bot' role
                } else {
                    appendMessage('bot', `Error: ${data.error || "An unknown error occurred."}`);
                }

            } catch (error) {
                // Remove the temporary loading message
                const loadingElement = document.getElementById(loadingMessageId);
                if (loadingElement) loadingElement.remove();

                appendMessage('bot', "Network Error: Could not connect to the server.");
                console.error(error);
            }
        }

        // 2. Helper: Append message to the conversation area
        function appendMessage(role, content, id = null) {
            const conversationArea = document.getElementById("conversationArea");
            
            // Note: We are keeping the initial two messages in the HTML, 
            // so we don't clear the innerHTML here unless we were starting from scratch.

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (id) messageDiv.id = id;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'bubble';

            if (role === 'user') {
                // User content is plain text
                bubbleDiv.textContent = content;
            } else { // role === 'bot'
                // AI content uses marked.parse for Markdown to HTML
                const formattedHTML = marked.parse(content);
                bubbleDiv.innerHTML = formattedHTML;
            }
            
            messageDiv.appendChild(bubbleDiv);
            conversationArea.appendChild(messageDiv);
            
            // Scroll to the bottom
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }


        // 3. Clear Conversation Function
        function clearConversation() {
            if (!confirm("Are you sure you want to clear the entire conversation history? This cannot be undone.")) {
                return;
            }
            conversationHistory = []; // Clear the JavaScript array
            
            // Clear the chat box completely and reset to an empty state
            const conversationArea = document.getElementById("conversationArea");
            conversationArea.innerHTML = `
                <div class="message bot">
                    <div class="bubble">Hi there! Let's get started, what grade are you teaching?</div>
                </div>
            `; 
            alert("Conversation cleared!");
        }


        // 4. Save as PDF Function (Uses html2pdf.js)
        function saveConversationAsPdf() {
            const conversationArea = document.getElementById('conversationArea');

            // Simple check to see if content is more than the initial messages
            if (conversationHistory.length === 0) {
                 alert('Please start a conversation before saving!');
                 return;
            }

            // Configuration for the PDF generation
            const pdfOptions = {
                margin: 10,
                filename: 'EduGenie_Chat_Session.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Use html2pdf to generate and download the PDF
            html2pdf().set(pdfOptions).from(conversationArea).save();
        }
    </script>
    </body>
</html>
