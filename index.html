<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EduGenie</title>
        <link rel = "stylesheet" href = "chatPage.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <link rel="icon" href="imgs/icon.png">
        
        </head>
    <body>
        <div class="chat-container">
            <div class="chat-header">eduGenie</div>

            <div id="controls" style="padding: 10px 20px 0; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="saveConversationAsPdf()" style="font-size: 14px; padding: 5px 10px;">Save as PDF</button>
                <button onclick="clearConversation()" style="font-size: 14px; padding: 5px 10px;">Clear Conversation</button>
            </div>
            
            <div class="chat-box" id="conversationArea">
                <div class="message bot">
                    <div class="bubble">Welcome to EduGenie! </div>
                </div>
            </div>

            <div class="chat-input">
              <select id="contentType" style="padding: 8px; margin-right: 10px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="general">General Question</option>
                <option value="lessonPlan">Lesson Plan</option>
                <option value="quiz">Quiz Questions</option>
                <option value="slides">Presentation Slides Outline</option>
            </select>
            <input type="text" id="prompt" placeholder="From topic to full lesson in one click." />
            <button onclick="askGemini()">Send</button>
        </div>
            </div>
        </div>

    <script>
        // Array to hold the conversation history (Q&A objects)
        // Stored as { role: 'user' | 'model', text: '...' } for server compatibility
        let conversationHistory = [];
        const MESSAGE_BOX_CONTAINER_ID = "messageBoxContainer";

        // --- Custom Message Box for Alerts/Confirms ---
        // (Replaces window.alert and window.confirm for better UI/compatibility)
        function showMessageBox(message, type = 'info', duration = 3000) {
            const container = document.getElementById(MESSAGE_BOX_CONTAINER_ID);
            const box = document.createElement('div');
            box.className = `message-box ${type}`;
            box.textContent = message;
            
            container.appendChild(box);

            setTimeout(() => {
                box.remove();
            }, duration);
        }

        // 1. Core Logic: Ask Gemini
        async function askGemini() {
            const promptInput = document.getElementById("prompt");
            const prompt = promptInput.value.trim();
            
            if (!prompt) return;

            // 1a. Display user question immediately
            appendMessage('user', prompt);
            
            // NOTE: We DO NOT push the user message to conversationHistory here. 
            // The server will add this current prompt as the final turn. 
            // We only send COMPLETED turns in the 'history' payload.

            promptInput.value = ''; // Clear input field
            promptInput.disabled = true;

            // 1b. Add a temporary 'Loading...' message
            const loadingMessageId = `loading-${Date.now()}`;
            appendMessage('bot', 'Thinking...', loadingMessageId); 
            
            try {
                // IMPORTANT: Send the full history array (containing only completed turns) 
                // along with the new prompt.
                const res = await fetch("http://localhost:5001/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt, history: conversationHistory })
                });

                const data = await res.json();
                
                // 1c. Remove the temporary loading message
                const loadingElement = document.getElementById(loadingMessageId);
                if (loadingElement) loadingElement.remove();
                promptInput.disabled = false;

                if (data.answer) {
                    // Only upon success, we record the completed turn (User Q + Model A)
                    // into the client-side history for the NEXT request.
                    conversationHistory.push({ role: 'user', text: prompt }); // Correctly push user turn
                    conversationHistory.push({ role: 'model', text: data.answer }); // Correctly push model turn

                    // Display the final AI answer
                    appendMessage('bot', data.answer); 
                } else {
                    const errorMessage = data.error || "An unknown error occurred.";
                    appendMessage('bot', `**Error:** ${errorMessage}`);
                    showMessageBox(`API Error: ${errorMessage}`, 'confirm', 5000); 
                }

            } catch (error) {
                // 1d. Handle network errors
                const loadingElement = document.getElementById(loadingMessageId);
                if (loadingElement) loadingElement.remove();
                promptInput.disabled = false;

                const networkErrorMsg = "Network Error: Could not connect to the server. Ensure the server is running on http://localhost:5001.";
                appendMessage('bot', networkErrorMsg);
                showMessageBox(networkErrorMsg, 'confirm', 7000);
                console.error(error);
            }
        }

        // 2. Helper: Append message to the conversation area
        function appendMessage(role, content, id = null) {
            const conversationArea = document.getElementById("conversationArea");
            
            const messageDiv = document.createElement('div');
            const displayRole = role === 'user' ? 'user' : 'bot'; 
            messageDiv.className = `message ${displayRole}`;
            if (id) messageDiv.id = id;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'bubble';

            if (displayRole === 'user') {
                bubbleDiv.textContent = content;
            } else { 
                const formattedHTML = marked.parse(content);
                bubbleDiv.innerHTML = formattedHTML;
            }
            
            messageDiv.appendChild(bubbleDiv);
            conversationArea.appendChild(messageDiv);
            
            // Scroll to the bottom
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }


        // 3. Clear Conversation Function
        function clearConversation() {
            // Using window.confirm as a temporary workaround for confirmation dialogs
            const isConfirmed = window.confirm("Are you sure you want to clear the entire conversation history?");
            
            if (!isConfirmed) {
                return;
            }
            
            conversationHistory = []; // Clear the JavaScript array
            
            // Clear the chat box completely and reset to the initial state
            const conversationArea = document.getElementById("conversationArea");
            conversationArea.innerHTML = `
                <div class="message bot">
                    <div class="bubble">Hi there! I'm your lesson planning assistant. To get started, what is the **topic or subject** you would like to work on?</div>
                </div>
            `; 
            showMessageBox("Conversation cleared!", 'info');
        }


        // 4. Save as PDF Function (Uses html2pdf.js)
        function saveConversationAsPdf() {
            const conversationArea = document.getElementById('conversationArea');

            if (conversationHistory.length === 0) {
                showMessageBox('Please start a conversation before saving!', 'confirm');
                return;
            }

            // Configuration for the PDF generation
            const pdfOptions = {
                margin: 10,
                filename: 'EduGenie_Chat_Session.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Use html2pdf to generate and download the PDF
            showMessageBox('Generating PDF...', 'info', 2000);
            html2pdf().set(pdfOptions).from(conversationArea).save();
        }

    </script>
    </body>
</html>
